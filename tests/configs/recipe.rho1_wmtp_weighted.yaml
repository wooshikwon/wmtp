# M3 Test Recipe - Rho1 WMTP Algorithm (Weighted Mode)
# Reference CE comparison based dynamic weighting for Multi-Token Prediction

# Run metadata
run:
  name: "m3_test_rho1_weighted"
  tags:
    - "test"
    - "m3"
    - "rho1"
    - "weighted"
    - "wmtp"

# Training configuration
train:
  algo: "rho1-wmtp"  # Reference CE comparison based weighting
  full_finetune: true
  num_epochs: 3  # SFT 표준: 데이터 3회 반복
  max_steps: 30  # 안전장치 (10 samples * 3 epochs = 30 steps 예상)
  # checkpointing moved to config.paths.checkpoints in Phase 2

# Optimizer configuration
optim:
  optimizer: "adamw"
  lr: 5.0e-5
  weight_decay: 0.01
  betas: [0.9, 0.999]
  grad_clip: 1.0
  scheduler: "constant"
  warmup_ratio: 0.0

# Data configuration
data:
  train:
    sources: ["mbpp"]
    max_length: 128
    batch_size: 1
    pack_sequences: false
  eval:
    sources: ["mbpp"]
    max_length: 128
    batch_size: 1
    pack_sequences: false

# Loss configuration (Phase 1 integration)
loss:
  weight_norm: "mean1.0_clip"
  lambda: 0.3
  weight_temperature: 0.7  # Weight softmax temperature (used in Rho1 weighted mode)
  epsilon: 0.05
  max_weight: 3.0

# Rho-1 specific configuration (Weighted Mode)
rho1:
  selection_mode: "weighted"  # Continuous weights for all tokens
  skip_threshold_percentile: 0.3  # Token skip 임계값 (weighted mode에서는 참고용)
  min_ce_diff: 0.01  # Phase 1.2: CE difference threshold for noise filtering

# Evaluation configuration
eval:
  protocol: "meta-mtp"
  sampling:
    temperature: 0.7
    top_p: 0.9
    n: 1
  metrics:
    - "mbpp_exact"
