# Weighted-MTP 프로젝트 현황 분석 보고서

## 요약

본 보고서는 Weighted-MTP(Weighted Multi-Token Prediction) 프로젝트의 현재 개발 상태를 분석하여 Phase 4까지 완료된 진행 상황과 향후 과제를 정리합니다. 프로젝트는 Meta AI의 MTP 기술과 토큰 중요도 가중화를 결합한 혁신적인 LLM 학습 방법론 개발을 목표로 하며, 현재 기초 인프라와 핵심 유틸리티 구축이 완료된 상태입니다.

## 1. 프로젝트 개요 및 목표

### 1.1 연구 목표
- **핵심 아이디어**: Multi-Token Prediction(MTP)과 토큰 중요도 가중화를 결합한 새로운 LLM 학습 방법론
- **두 가지 접근법**:
  1. **Critic-Weighted MTP**: 강화학습 기반 Critic을 활용한 토큰 가중치 부여
  2. **Rho-1 Weighted MTP**: Reference 모델 기반 토큰 중요도 산출 (Critic-free)

### 1.2 기술적 특징
- Meta AI의 7B MTP 사전학습 모델 기반
- MBPP 및 CodeContests 데이터셋 활용
- A100 GPU 4장 기준 Full Fine-tuning 및 LoRA 옵션 지원
- MLflow + S3 기반 실험 관리 및 모델 버전 관리

## 2. 개발 진행 현황 (Phase 4 완료)

### Phase 0: Repository & Governance Bootstrap ✅
- **완료 사항**:
  - Git 레포지토리 초기화 및 브랜치 전략 수립
  - 프로젝트 문서 구조 확립 (BLUEPRINT.md, DEV_PLANS.md, DEV_PRINCIPLE.md)
  - 초기 커밋: "chore: bootstrap repository with project structure and configuration"

### Phase 1: Environment & Package Management ✅
- **완료 사항**:
  - Python 3.11 + uv 패키지 매니저 설정
  - 디렉토리 구조 생성 (src/, configs/, tests/)
  - CLI 엔트리포인트 구현 (train.py, eval.py)

### Phase 2: Settings Schema & YAML Contracts ✅
- **완료 사항**:
  - Pydantic 기반 설정 스키마 구현
  - config.yaml (환경 설정) 및 recipe.yaml (학습 설정) 템플릿 작성
  - 두 가지 레시피 예제: critic-wmtp, rho1-wmtp

### Phase 3: Registry & Factory Pattern ✅
- **완료 사항**:
  - 컴포넌트 레지스트리 시스템 구현
  - 플러그인 가능한 아키텍처 기반 구축
  - Factory 패턴을 통한 동적 컴포넌트 생성

### Phase 4: Utils Consolidation ✅
- **완료 사항**:
  - 핵심 유틸리티 모듈 구현:
    - `utils/s3.py`: S3 스토리지 인터페이스
    - `utils/hf.py`: HuggingFace 모델 로딩
    - `utils/mlflow.py`: 실험 추적 및 로깅
    - `utils/dist.py`: 분산 학습 지원
    - `utils/eval.py`: 평가 메트릭 계산

## 3. 현재 코드베이스 구조

```
wmtp/
├── src/
│   ├── cli/                  # 명령줄 인터페이스
│   │   ├── __main__.py
│   │   ├── train.py          # 학습 엔트리포인트
│   │   └── eval.py           # 평가 엔트리포인트
│   ├── components/           # 핵심 컴포넌트
│   │   ├── base.py          # 기본 인터페이스
│   │   ├── registry.py      # 레지스트리 시스템
│   │   ├── scorer/          # 토큰 가중치 산출
│   │   │   ├── critic_delta.py
│   │   │   └── rho1_excess.py
│   │   ├── evaluator/       # 평가 모듈
│   │   │   ├── mbpp_eval.py
│   │   │   └── codecontests.py
│   │   ├── loader/          # 데이터/모델 로더
│   │   ├── trainer/         # 학습 모듈
│   │   └── optimizer/       # 최적화 모듈
│   ├── factory/             # 팩토리 패턴
│   │   └── component_factory.py
│   ├── pipelines/           # 파이프라인 오케스트레이션
│   ├── settings/            # 설정 관리
│   │   ├── config_schema.py
│   │   ├── recipe_schema.py
│   │   └── loader.py
│   └── utils/               # 유틸리티 모듈
├── configs/                 # 설정 파일
│   ├── config.example.yaml
│   ├── recipe.example.yaml
│   └── recipe.rho1.example.yaml
├── tests/                   # 테스트 코드
└── docs/                    # 프로젝트 문서
```

## 4. 기술적 의사결정 및 개선 사항

### 4.1 초기 제안서 대비 주요 개선점

1. **Critic 의존성 완화**:
   - 교수님 피드백 반영: Value estimation의 불안정성 우려 해결
   - Rho-1 방식 추가: Reference 모델 기반 토큰 스코어링으로 대안 제시
   - GRPO 스타일의 critic-free 접근법 고려

2. **손실 함수 개선**:
   - 토큰 가중치 정규화: 평균 1.0 유지, 클리핑 적용
   - 안정화 메커니즘: z-score 정규화, softmax 온도 제어
   - Gradient 기반 중요도 산출 옵션 추가

3. **실험 프로토콜 확립**:
   - Meta MTP 논문 평가 프로토콜 재현
   - MBPP exact-match, CodeContests pass@k 지표 채택
   - 표준 샘플링 파라미터 고정 (T=0.2, top-p=0.95)

### 4.2 아키텍처 설계 원칙

1. **모듈성과 확장성**:
   - 레지스트리 패턴으로 컴포넌트 교체 용이
   - YAML 설정 기반 동작 제어 (코드 변경 최소화)
   - 파이프라인별 독립적 실행 가능

2. **재현성과 관찰성**:
   - MLflow를 통한 완전한 실험 추적
   - S3 기반 아티팩트 관리
   - 결정론적 시드 및 환경 고정

3. **성능과 안정성**:
   - FSDP 기반 분산 학습 지원
   - bf16 정밀도 및 그래디언트 체크포인팅
   - OOM/NaN 자동 폴백 메커니즘

## 5. 다음 단계 (Phase 5~15)

### 즉시 착수 필요 (Phase 5-8)
- **Phase 5**: Data & Model Loaders 구현
- **Phase 6**: Scorer 모듈 완성 (Critic & Rho-1)
- **Phase 7**: Trainer 및 Optimizer 통합
- **Phase 8**: Pipeline 오케스트레이션 완성

### 중기 목표 (Phase 9-12)
- **Phase 9**: 평가 하네스 구현
- **Phase 10**: MLflow/S3 통합 완성
- **Phase 11**: Docker/VESSL 배포 환경 구축
- **Phase 12**: 테스트 피라미드 구축

### 장기 목표 (Phase 13-15)
- **Phase 13**: 실제 데이터 학습 실행
- **Phase 14**: 하이퍼파라미터 최적화
- **Phase 15**: 프로덕션 릴리스

## 6. 위험 요소 및 대응 방안

### 6.1 기술적 위험
1. **가중 CE 손실 불안정성**:
   - 대응: 클리핑, 정규화, 온도 제어로 안정화

2. **OOM 문제**:
   - 대응: FSDP, activation checkpointing, 동적 배치 조정

3. **Critic 학습 수렴 문제**:
   - 대응: Rho-1 방식으로 대체 경로 확보

### 6.2 프로젝트 위험
1. **MTP 모델 접근성**:
   - 현황: Meta 공개 모델 활용 계획
   - 대안: 필요시 자체 MTP 사전학습

2. **컴퓨팅 리소스**:
   - 요구사항: A100 4장 (7B 모델 Full FT)
   - 대안: LoRA/QLoRA로 리소스 절감

## 7. 핵심 성과 지표 (KPI)

### 7.1 연구 성과
- MBPP exact-match 정확도 향상률
- CodeContests pass@1, pass@5 개선도
- 학습 효율성 (tokens/second, 수렴 속도)

### 7.2 엔지니어링 성과
- 코드 커버리지 > 80%
- 실험 재현성 100%
- 파이프라인 실행 성공률 > 95%

## 8. 결론 및 권고사항

### 8.1 현황 평가
프로젝트는 Phase 4까지 계획대로 진행되어 기초 인프라와 핵심 유틸리티가 성공적으로 구축되었습니다. 레지스트리 기반 아키텍처와 설정 주도 설계로 확장성과 유지보수성을 확보했으며, 두 가지 접근법(Critic/Rho-1)을 동시에 실험할 수 있는 기반을 마련했습니다.

### 8.2 권고사항

1. **즉시 착수 사항**:
   - Phase 5-6의 핵심 컴포넌트 구현 가속화
   - 스모크 테스트를 통한 엔드투엔드 검증
   - MLflow 실험 추적 시스템 실제 연동

2. **중점 관리 영역**:
   - 토큰 가중치 안정화 메커니즘 지속 모니터링
   - GPU 메모리 효율성 프로파일링
   - 평가 프로토콜의 정확한 재현

3. **리스크 관리**:
   - Critic 방식과 Rho-1 방식 병행 개발 유지
   - 주기적인 체크포인트 및 백업
   - 실험 결과의 체계적 문서화

### 8.3 예상 일정
- **Phase 5-8 완료**: 2주
- **Phase 9-12 완료**: 3주
- **Phase 13-15 완료**: 4주
- **전체 프로젝트 완료**: 약 9주

본 프로젝트는 LLM 학습 효율성 개선이라는 중요한 연구 과제를 다루고 있으며, 체계적인 개발 계획과 견고한 아키텍처를 바탕으로 성공적인 결과를 기대할 수 있습니다.

---

*작성일: 2025년 9월 22일*
*작성자: WMTP 프로젝트 팀*
*버전: 1.0*
